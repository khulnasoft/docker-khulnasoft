# Copyright 2018-2021 Khulnasoft
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

ARG KHULNASOFT_BASE_IMAGE=base-debian-10

#
# Download and unpack Khulnasoft Universal Forwarder
#
FROM ${KHULNASOFT_BASE_IMAGE}:latest as package
ARG KHULNASOFT_BUILD_URL
ENV KHULNASOFT_HOME=/opt/khulnasoftforwarder
RUN echo "Downloading Khulnasoft and validating the checksum at: ${KHULNASOFT_BUILD_URL}" \
    && wget -qO /tmp/`basename ${KHULNASOFT_BUILD_URL}` ${KHULNASOFT_BUILD_URL} \
    && wget -qO /tmp/khulnasoft.tgz.sha512 ${KHULNASOFT_BUILD_URL}.sha512 \
    && cd /tmp \
    && echo "$(cat /tmp/khulnasoft.tgz.sha512)" | sha512sum --check  --status \
    && rm /tmp/khulnasoft.tgz.sha512 \
    && tar -C /opt -zxf /tmp/`basename ${KHULNASOFT_BUILD_URL}` \ 
    && mv ${KHULNASOFT_HOME}/etc ${KHULNASOFT_HOME}-etc \
    && mkdir -p ${KHULNASOFT_HOME}/etc ${KHULNASOFT_HOME}/var
COPY uf/common-files/apps ${KHULNASOFT_HOME}-etc/apps/


#
# Bare Khulnasoft Universal Forwarder Image without Ansible (BYO entrypoint)
#
FROM ${KHULNASOFT_BASE_IMAGE}:latest as bare
LABEL maintainer="support@khulnasoft.com"

# Currently kubernetes only accepts UID and not USER field to
# start a container as a particular user. So we create Khulnasoft
# user with pre-determined UID.
ARG UID=41812
ARG GID=41812

ENV KHULNASOFT_HOME=/opt/khulnasoftforwarder \
    KHULNASOFT_GROUP=khulnasoft \
    KHULNASOFT_USER=khulnasoft

# Simple script used to populate/upgrade khulnasoft/etc directory
COPY [ "uf/common-files/updateetc.sh", "/sbin/"]

# Setup users and groups
RUN groupadd -r -g ${GID} ${KHULNASOFT_GROUP} \
    && useradd -r -m -u ${UID} -g ${GID} -s /bin/bash ${KHULNASOFT_USER} \
    && chmod 755 /sbin/updateetc.sh

# Copy files from package
COPY --from=package --chown=khulnasoft:khulnasoft /opt /opt

USER ${KHULNASOFT_USER}
WORKDIR ${KHULNASOFT_HOME}
EXPOSE 8089 8088 9997
VOLUME [ "/opt/khulnasoftforwarder/etc", "/opt/khulnasoftforwarder/var" ]



#
# Full Khulnasoft Universal Forwarder Image with Ansible
#
FROM bare

ARG KHULNASOFT_DEFAULTS_URL

ENV KHULNASOFT_ROLE=khulnasoft_universal_forwarder \
    KHULNASOFT_DEFAULTS_URL=${KHULNASOFT_DEFAULTS_URL} \
    KHULNASOFT_ANSIBLE_HOME=/opt/ansible \
    KHULNASOFT_OPT=/opt \
    ANSIBLE_USER=ansible \
    ANSIBLE_GROUP=ansible \
    CONTAINER_ARTIFACT_DIR=/opt/container_artifact

# Copy ansible playbooks
COPY khulnasoft-ansible ${KHULNASOFT_ANSIBLE_HOME}

# Copy scripts
COPY [ "uf/common-files/entrypoint.sh", "uf/common-files/checkstate.sh", "uf/common-files/createdefaults.py", "/sbin/"]

USER root

# Setup users and groups
RUN sed -i -e 's/%sudo\s\+ALL=(ALL\(:ALL\)\?)\s\+ALL/%sudo ALL=NOPASSWD:ALL\nansible ALL=(khulnasoft)NOPASSWD:ALL/g' /etc/sudoers \
    && microdnf install systemd \
    && echo 'Create the ansible user/group' \
    && groupadd -r ${ANSIBLE_GROUP} \
    && useradd -r -m -g ${ANSIBLE_GROUP} -s /bin/bash ${ANSIBLE_USER} \
    && usermod -aG sudo ${ANSIBLE_USER} \
    && usermod -aG ${ANSIBLE_GROUP} ${KHULNASOFT_USER} \
    && echo 'Container Artifact Directory is a place for all artifacts and logs that are generated by the provisioning process. The directory is owned by the user "ansible".' \
    && mkdir ${CONTAINER_ARTIFACT_DIR} \
    && chown -R ${ANSIBLE_USER}:${ANSIBLE_GROUP} ${CONTAINER_ARTIFACT_DIR} \
    && chmod -R 775 ${CONTAINER_ARTIFACT_DIR} \
    && chmod -R 555 ${KHULNASOFT_ANSIBLE_HOME} \
    && chgrp ${ANSIBLE_GROUP} ${KHULNASOFT_ANSIBLE_HOME} ${KHULNASOFT_ANSIBLE_HOME}/ansible.cfg \
    && chmod 775 ${KHULNASOFT_ANSIBLE_HOME} \
    && chmod 664 ${KHULNASOFT_ANSIBLE_HOME}/ansible.cfg \
    && sed -i '/^\[defaults\]/a\interpreter_python = /usr/bin/python3' ${KHULNASOFT_ANSIBLE_HOME}/ansible.cfg \
    && chmod 755 /sbin/entrypoint.sh /sbin/createdefaults.py /sbin/checkstate.sh

USER ${ANSIBLE_USER}
HEALTHCHECK --interval=30s --timeout=30s --start-period=3m --retries=5 CMD /sbin/checkstate.sh || exit 1
ENTRYPOINT [ "/sbin/entrypoint.sh" ]
CMD [ "start-service" ]
